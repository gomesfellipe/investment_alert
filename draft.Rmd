---
title: "Untitled"
author: "MTBR - ModelThinkingBR"
date: "3/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(purrr)
library(alphavantager) # https://www.business-science.io/code-tools/2017/09/03/alphavantager-0-1-0.html
library(tidyquant)
library(ggplot)
library(GGally)
library(forecast)

# carteira = c("BTC-USD", "ITSA4.SA","PETR4.SA",  "GOAU4.SA", "MYPK3.SA", "MGLU3", "COGN3.SA")

key <- "TIMTJBAT1ENM1XF1"
av_api_key(key)
print(av_api_key())

```

# Quanto investir?

```{r}
calcular_carteira <- function(entrada = NULL,
                              renda_fixa = NULL,
                              renda_variavel = NULL,
                              crypto_moeda = NULL){
  
  # Caso input = entrada
  if(is.null(renda_fixa) & is.null(renda_variavel)){
    renda_fixa <- entrada * .6
    renda_variavel <- entrada * .3
    crypto_moeda <- entrada * 0.1
  }
  
  # Caso input = renda_variavel
  if(is.null(renda_fixa) & is.null(entrada)){
    renda_fixa <- (renda_variavel * 0.6) / 0.3
    crypto_moeda <- renda_variavel / 3
    entrada <- renda_fixa + renda_variavel + crypto_moeda
  }
  
  return(
    c(entrada = entrada, 
      renda_fixa = renda_fixa, 
      renda_variavel = renda_variavel,
      crypto_moeda = crypto_moeda)
  )
}

calcular_carteira(entrada = 10000)
calcular_carteira(renda_variavel = 7500)
```


```{r}
portifolio = c("PETR4.SA", "BTC-USD")
```



```{r}
request <- 
  portifolio %>% 
  map(~getSymbols(.x, auto.assign = F, from = "2019-01-01"))
```

```{r, eval = F}
request <- 
  portifolio %>% 
  (function(x){map(x, ~quantmod::getSymbols(.x, auto.assign = F, from = "2019-01-01")) %>% 
      map2_df(x, ~
                .x %>%
                zoo::fortify.zoo() %>%
                as_tibble() %>%
                `colnames<-`(c("index", "open", "high", "low", 
                               "close", "volume", "adjusted")) %>% 
                mutate(stock = .y)
      )})
```

Comportamento das series

```{r}
request %>%
  ggplot(aes(x = index, y = close)) +
  geom_candlestick(aes(open = open, high = high, low = low, close = close),
                   colour_up = "darkgreen", colour_down = "darkred", 
                   fill_up  = "darkgreen", fill_down  = "darkred") +
  theme_bw()+
  facet_wrap(~stock, scales = "free_y", ncol = 1)
```

correlacoes

```{r}
request %>% 
  select(index, close, stock) %>% 
  tidyr::spread(key = stock, value = close) %>% 
  filter(!is.na(PETR4.SA)) %>% 
  select(-index) %>% 
  cor(method = "spearman")
```

previsao

```{r}
request[[1]] %>% .[,grep("Close", colnames(.))]
```


```{r}
request <- map(carteira, ~av_get(symbol = .x,
                                 av_fun = "TIME_SERIES_INTRADAY", 
                                 interval = "15min", # "1min", "5min", "15min", "30min" ou "60min"
                                 outputsize = "full") # "compact"
) %>% `names<-`(carteira)
tidyquant::tq_portfolio()

```

Erro: Thank you for using Alpha Vantage! Our standard API call frequency is 5 calls per minute and 500 calls per day.
